<!DOCTYPE html>
<html>
    <head>
        <title>Exposure Same Different</title>
        <script src='jatos.js'></script>
        <script src='./jspsych-6.3.1/jspsych.js'></script>        
        <script src='./extra_functions/lodash.js'></script>
        <script src = './extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
        <script src="./jspsych-6.3.1/plugins/jspsych-image-keyboard-response.js"></script>
        <script src="./extra_functions/jspsych-exposure-keyboard-response.js"></script>
        <script src="./jspsych-6.3.1/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="./jspsych-6.3.1/plugins/jspsych-preload.js"></script>
        <link href='./jspsych-6.3.1/css/jspsych.css' rel='stylesheet' type='text/css'></link>
        <link href='./extra_files/custom.css' rel='stylesheet' type='text/css'></link>
    </head>
    <body></body>
    <script>

        jatos.onLoad(function() {
            // debugger
            jatos.studySessionData.inputData.session_counters.exposure ++ 

            // Create the snippets for stimulus trials
            var session_trials = jatos.studySessionData.inputData.exposure_trials[jatos.studySessionData.inputData.session_counters.exposure-1]

            var fixation_trial = {
                type: 'exposure-keyboard-response',
                prompt: 'Is the bird the same as the one before? Press 1 for same, 2 for different.',
                choices: jsPsych.NO_KEYS,
                stimulus: 'img/fixation.png',
                stimulus_height: 500,
                x_offset: 0,
                y_offset: 50,
                trial_duration: jatos.studySessionData.inputData.experiment_parameters.fixation_trial_dur,
                response_ends_trial: false,
                data: { trial_stage: 'fixation' }                
            }

            var exposure_trial = {
                type: 'exposure-keyboard-response',
                prompt: 'Is the bird the same as the one before? Press 1 for same, 2 for different.',
                choices: ['1','2'],
                stimulus: jsPsych.timelineVariable('stimulus'),
                x_offset: jsPsych.timelineVariable('x_offset'),
                y_offset: jsPsych.timelineVariable('y_offset'),
                trial_duration: jatos.studySessionData.inputData.experiment_parameters.exposure_trial_dur,
                response_ends_trial: true,
                data: { trial_stage: 'exemplar_display' }                
            }

            var session_procedure = {
                timeline: [exposure_trial,fixation_trial],
                timeline_variables: session_trials,
                randomize_order: false,
                post_trial_gap: 0,
            }
            
            // Create the preload trial
            var preload_trial = {
                type: 'preload',
                images: [jatos.studySessionData.inputData.all_exemplars,'img/fixation.png'],
            }

            jsPsych.init({
                timeline: [preload_trial,session_procedure],  
                // show_progress_bar: true,                 
              
                on_finish: function(data){
                    // debugger
                    jatos.studySessionData.outputData.exposure.push(...data.values().filter(item => item.trial_stage == 'exemplar_display'))

                    // Make JATOS remember that this session was run
                    jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
                    jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
                    jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

                    jatos.submitResultData("[exposure_start---" + 
                    JSON.stringify(jatos.studySessionData) + "---exposure_end]",
                    function(){jatos.startComponentByPos(
                        jatos.studySessionData.inputData.component_positions.break
                        )})
                }

                // on_finish: function(data) {
                //     console.log('Over');
                //     jsPsych.data.displayData('json');
                // }       
            });
   
            // ///////////////////////////////////////////////////////////////////////////////////////////////
            //////////////////////////////////////////////////////////////////////////////////////////////////
        });
    
    </script>
</html>
