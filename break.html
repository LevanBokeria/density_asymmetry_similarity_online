<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0">
    <title>Break</title>	
	<script src="jspsych-6.3.1/jspsych.js" ></script>
	<script src='./jspsych-6.3.1/plugins/jspsych-instructions.js'></script>
	<script src='./jspsych-6.3.1/plugins/jspsych-html-slider-response.js'></script>
	<script src="jatos.js"></script>
	<link rel="stylesheet" href="jspsych-6.3.1/css/jspsych.css" type="text/css"></link>
	<link rel="stylesheet" href="./extra_files/custom.css" type="text/css"></link>	
  </head>

  <body>
  <script>

		//start timeline
		jatos.onLoad(function() {

			const calc_perf = function(data){
				
				let perc_corr

				// Get trials that had a correct response
				let correct_exists = data.filter(item => item.correct_response != null)

				// Count the number of correct responses
				let n_corr = correct_exists.filter(item => item.correct == true).length

				perc_corr = n_corr * 100 / correct_exists.length

				return perc_corr
			}

			let comp_to_start = []

			// Whats the title of the break page? This will change if exposure is about to begin.
			var page_title = 'Break'

			//make a timeline
			let timeline =[]; 

			let instructions_text = []


			// Was last finished condition an exposure one?
			if (jatos.studySessionData.latestFinishedComponentPos == jatos.studySessionData.inputData.component_positions.exposure){

				// Check if all sessions done:
				if (jatos.studySessionData.inputData.experiment_parameters.n_exposure_sessions == jatos.studySessionData.inputData.session_counters.exposure){
					
					// Calculate performance on the "same" trials
					let perc_corr_same = calc_perf(
						jatos.studySessionData.outputData.exposure.filter(
							item => item.session == jatos.studySessionData.inputData.session_counters.exposure & item.correct_response == 'q')
					)

					let perc_corr_diff = calc_perf(
						jatos.studySessionData.outputData.exposure.filter(
							item => item.session == jatos.studySessionData.inputData.session_counters.exposure & item.correct_response == 'p')
					)

					instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr_same) + '% of the "same" trials and ' + Math.floor(perc_corr_diff) + '% of the "different" trials! <br> You have finished the "same/different" task. <br> <strong>Please take a break of no more than 1 minute!</strong><br>Next, you will do the similarity judgment task one more time.'

					comp_to_start = jatos.studySessionData.inputData.component_positions.triplet_task

				} else {
					
					// Calculate performance on the "same" trials
					let perc_corr_same = calc_perf(
						jatos.studySessionData.outputData.exposure.filter(
							item => item.session == jatos.studySessionData.inputData.session_counters.exposure & item.correct_response == 'q')
					)

					let perc_corr_diff = calc_perf(
						jatos.studySessionData.outputData.exposure.filter(
							item => item.session == jatos.studySessionData.inputData.session_counters.exposure & item.correct_response == 'p')
					)

					instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr_same) + '% of the "same" trials and ' + Math.floor(perc_corr_diff) + '% of the "different" trials! <br> You have finished session ' + jatos.studySessionData.inputData.session_counters.exposure + ' of ' + jatos.studySessionData.inputData.experiment_parameters.n_exposure_sessions + ' of the "same/different" task. Please take a short break of maximum 30 seconds and then continue.'

					comp_to_start = jatos.studySessionData.inputData.component_positions.exposure

				}

			} else if (jatos.studySessionData.latestFinishedComponentPos == jatos.studySessionData.inputData.component_positions.triplet_task){

				// Check if pre-exposure happened already or not
				if (jatos.studySessionData.inputData.session_counters.pre_exposure == 0){

					// Calculate performance
					let perc_corr = calc_perf(jatos.studySessionData.outputData.practice)

					instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr) + '% of the trials! <br> Those were practice trials. Now you will do the real trials! <br><br> You will do a total of '+ jatos.studySessionData.inputData.experiment_parameters.n_pre_exp_triplet_sessions + ' sessions, each with '+ jatos.studySessionData.inputData.pre_exposure_trials[0].length + ' trials.'
					comp_to_start = jatos.studySessionData.inputData.component_positions.triplet_task			
				} else if (jatos.studySessionData.inputData.session_counters.exposure == 0){
					// So we're done with pre-exposure
					// debugger
					// Now check if all sessions ran or not
					if (jatos.studySessionData.inputData.session_counters.pre_exposure == jatos.studySessionData.inputData.experiment_parameters.n_pre_exp_triplet_sessions){
						// debugger
						// Calculate performance
						let perc_corr = calc_perf(jatos.studySessionData.outputData.pre_exposure.filter(item => item.session == jatos.studySessionData.inputData.session_counters.pre_exposure))

						instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr) + '% of trials! <br> That was the end of the similarity task #1. <br>Now we will move onto the same/difference task. <br><br>You will see these birds show up on the screen one-by-one. The task is simple: if the bird you see is exactly the same as you saw on the previous trial, press the button "q". If the current bird is different than the previous one, press the button "p". <br><br> You will do a total of '+jatos.studySessionData.inputData.experiment_parameters.n_exposure_sessions+' sessions for the same/difference task, each with '+ jatos.studySessionData.inputData.exposure_trials[0].length +' trials. <br><br> You will have '+ (jatos.studySessionData.inputData.experiment_parameters.exposure_trial_dur/1000) +' seconds on each trial to make your response!' + 
						'<br><p>Please take a 1 minute break and then start the next task!</p>'

						comp_to_start = jatos.studySessionData.inputData.component_positions.exposure

						page_title = 'Beginning the Same/difference task!'


					} else {

						// debugger
						// Calculate performance
						let perc_corr = calc_perf(jatos.studySessionData.outputData.pre_exposure.filter(item => item.session == jatos.studySessionData.inputData.session_counters.pre_exposure))


						instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr) + '% of trials! <br> You have finished session ' + jatos.studySessionData.inputData.session_counters.pre_exposure + ' of ' + jatos.studySessionData.inputData.experiment_parameters.n_pre_exp_triplet_sessions + ' of the similarity  task. Please take a short break of maximum 30 seconds and then continue.'
						comp_to_start = jatos.studySessionData.inputData.component_positions.triplet_task

					}

				} else {

					// So we're done with post-exposure

					// Now check if all sessions ran or not
					if (jatos.studySessionData.inputData.session_counters.post_exposure == jatos.studySessionData.inputData.experiment_parameters.n_post_exp_triplet_sessions){

						// debugger
						// Calculate performance
						let perc_corr = calc_perf(jatos.studySessionData.outputData.post_exposure.filter(item => item.session == jatos.studySessionData.inputData.session_counters.post_exposure))

						instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr) + '% of trials! <br> You are finished with the experiment! <br> Please complete some debriefing questions.'
						comp_to_start = jatos.studySessionData.inputData.component_positions.debriefing

						page_title = 'Finished!'

					} else {

						// debugger
						// Calculate performance
						let perc_corr = calc_perf(jatos.studySessionData.outputData.post_exposure.filter(item => item.session == jatos.studySessionData.inputData.session_counters.post_exposure))

						instructions_text = 'Thanks! You were accurate on ' + Math.floor(perc_corr) + '% of trials! <br> You have finished session ' + jatos.studySessionData.inputData.session_counters.post_exposure + ' of ' + jatos.studySessionData.inputData.experiment_parameters.n_post_exp_triplet_sessions + ' of the similarity  task. Please take a short break of maximum 30 seconds and then continue.'
						comp_to_start = jatos.studySessionData.inputData.component_positions.triplet_task

					}
				}

			}

			// let curr_session = jatos.studySessionData.inputData.curr_session

			// if (curr_session == jatos.studySessionData.inputData.all_sessions.length){

			// 	instructions_text = 'Thank you. You have finished the experiment. Please complete a short debriefing.'

			// 	comp_to_start = jatos.studySessionData.inputData.component_positions.debriefing2
			// } else if (curr_session == 1){

			// 	// So we just finished the practice session
			// 	instructions_text = 'Great! These were practice trials on the purple board. You will not see that board or those pictures again. <br> Lets start with the real trials. You will learn location of pictures on 5 new different boards that are colored differently. <br> <strong>On some of these boards, the visible items you will see at the beginning of trials might change locations or be absent completely!</strong> <br> For each of the 5 boards, you will do ' + jatos.studySessionData.inputData.n_ses_per_condition.schema_c + ' sessions, each session with ' + (jatos.studySessionData.inputData.n_trials_per_pa.schema_c*6) + ' trials (' + jatos.studySessionData.inputData.n_trials_per_pa.schema_c + ' trials per hidden picture). <br><br> Click next to start with the first board'

			// 	comp_to_start = jatos.studySessionData.inputData.component_positions.session_pa2

			// } else {

			// 	let previous_condition = jatos.studySessionData.inputData.all_sessions[curr_session-1][0].condition
			// 	let next_condition     = jatos.studySessionData.inputData.all_sessions[curr_session][0].condition

			// 	if (previous_condition != next_condition){
			// 		// So we're changing the board

			// 		if (next_condition == 'no_schema'){
			// 			instructions_text = '<strong>On the next board, there are no visible items.</strong> You will only learn location of the 6 invisible items. <br> Please take a break and move onto the next board.'
			// 		} else {
			// 			instructions_text = 'Please take a break. <br> <strong>Next, you will learn a new board with new pictures.</strong>'
			// 		}
			// 	} else {
			// 		instructions_text = 'Please take a break. You will continue learning the locations of the same images on this ' + jatos.studySessionData.inputData.condition_colors[previous_condition] + ' board. Once you are ready please move to the next session.'
			// 	}
				
			// 	comp_to_start = jatos.studySessionData.inputData.component_positions.session_pa2

			// }

			var instructions = {
					type: 'instructions',
					pages : [			
						'<div class= "header">'+
							'<h1>' + page_title + '</h1>'+
						'</div>'+	
						'<div class="instruct">'+
							'<p>' + instructions_text + '</p>' + 
						'</div>',
					],						
					show_clickable_nav: true,
					button_label_next: '<span style="color: black"d;> <strong> Next </stong></span>',
				};

			timeline.push(instructions);

			jsPsych.init({
				
				timeline: timeline,

				on_finish: function(data) {

					// Make JATOS remember that this session was run
                    jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
                    jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
                    jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

					jatos.submitResultData('[break_start_' + '---' + 
					JSON.stringify(jatos.studySessionData) +
					'---' + '_break_end]', 
					function(){jatos.startComponentByPos(comp_to_start)});

					// jsPsych.data.displayData();
				}
			});

		});


	</script>
</body>
</html>