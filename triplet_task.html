<!DOCTYPE html>
<html>
    <head>
        <title>Triplet task</title>
        <script src='jatos.js'></script>
        <script src='./jspsych-6.3.1/jspsych.js'></script>        
        <script src='./extra_functions/lodash.js'></script>
        <script src = './extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
        <script src="./extra_functions/jspsych-triplets-keyboard-response.js"></script>
        <script src="./jspsych-6.3.1/plugins/jspsych-preload.js"></script>
        <link href='./jspsych-6.3.1/css/jspsych.css' rel='stylesheet' type='text/css'></link>
        <link href='./extra_files/custom.css' rel='stylesheet' type='text/css'></link>
    </head>
    
    <body></body>
    
    <script>
        jatos.onLoad(function() {
            // debugger
            var session_trials = []
            var trial_stage_name = []

            // Is this pre or post
            if (jatos.studySessionData.inputData.session_counters.exposure == 0){

                jatos.studySessionData.inputData.session_counters.pre_exposure++

                session_trials = jatos.studySessionData.inputData.pre_exposure_trials[jatos.studySessionData.inputData.session_counters.pre_exposure-1]
                trial_stage_name = 'pre_exposure_triplets'

            } else {
                
                jatos.studySessionData.inputData.session_counters.post_exposure++

                session_trials = jatos.studySessionData.inputData.post_exposure_trials[jatos.studySessionData.inputData.session_counters.post_exposure-1]
                trial_stage_name = 'post_exposure_triplets'

            }

            var trial = {
                type: 'triplets-keyboard-response',
                query_stimulus: jsPsych.timelineVariable('query_stimulus'),
                ref1_stimulus: jsPsych.timelineVariable('ref1_stimulus'),
                ref2_stimulus: jsPsych.timelineVariable('ref2_stimulus'),
                ref1_y_offset: jsPsych.timelineVariable('ref1_y_offset'),
                ref2_y_offset: jsPsych.timelineVariable('ref2_y_offset'),
                stimulus_height: 400,
                choices: ['1','2'],
                trial_duration: jatos.studySessionData.inputData.experiment_parameters.triplet_trial_dur,
                post_trial_gap: jatos.studySessionData.inputData.experiment_parameters.triplet_trial_iti,
                data: { trial_stage: trial_stage_name }                
            }
            
            var session_procedure = {
                timeline: [trial],
                timeline_variables: session_trials,
                randomize_order: false,
                post_trial_gap: 0,
            }

            // Preload trial
            var preload_trial = {
                type: 'preload',
                images: jatos.studySessionData.inputData.all_exemplars
            }

            jsPsych.init({
                
                timeline: [preload_trial,session_procedure],  
                
                on_finish: function(data) {
                    // debugger
                    // Get the data and save it!
                    if (jatos.studySessionData.inputData.session_counters.exposure == 0){
                        jatos.studySessionData.outputData.pre_exposure.push(...data.values().filter(item => item.trial_stage == trial_stage_name))

                    } else {
                        jatos.studySessionData.outputData.post_exposure.push(...data.values().filter(item => item.trial_stage == trial_stage_name))
                    }                    

                    // Make JATOS remember that this session was run
                    jatos.studySessionData.latestFinishedComponentId    = jatos.componentId;
                    jatos.studySessionData.latestFinishedComponentPos   = jatos.componentPos;
                    jatos.studySessionData.latestFinishedComponentTitle = jatos.componentProperties.title;

                    jatos.submitResultData("[triplet_task_start---" + 
                    JSON.stringify(jatos.studySessionData) + "---triplet_task_end]",
                    function(){jatos.startComponentByPos(
                        jatos.studySessionData.inputData.component_positions.break
                        )})                }       
            });

        }); // jatos on load

    </script>
</html>
