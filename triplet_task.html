<!DOCTYPE html>
<html>
    <head>
        <title>Triplet task</title>
        <script src='jatos.js'></script>
        <script src='./jspsych-6.3.1/jspsych.js'></script>        
        <script src='./extra_functions/lodash.js'></script>
        <script src = './extra_functions/jquery-3.4.1.js' type='text/javascript'></script>
        <script src="./jspsych-6.3.1/plugins/jspsych-canvas-keyboard-response.js"></script>
        <script src="./jspsych-6.3.1/plugins/jspsych-preload.js"></script>
        <link href='./jspsych-6.3.1/css/jspsych.css' rel='stylesheet' type='text/css'></link>
        <link href='./extra_files/custom.css' rel='stylesheet' type='text/css'></link>
    </head>
    <body></body>
    <script>

        jatos.onLoad(function() {
        // debugger
        // List of triplets
        var triplet_list = [
            [50,20,110],
            [120,90,180],
            [230,200,290],
            [20,25,85],
            [50,55,115],
            [115,120,180],
            [135,140,200],
            [80,40,100],
            [160,120,180],
            [260,220,280],
            [60,20,130],
            [140,110,210],
            [210,170,280],
            [110,20,240],
            [160,70,290],
            [140,50,270],
            [30,20,50],
            [140,130,160],
            [260,250,280],
            [55,35,115],
            [140,120,200],
            [210,190,270],
            [40,80,120],
            [120,160,200],
            [200,240,280],
            [40,90,120],
            [120,170,200],
            [200,250,280],
            [110,30,230],
            [140,60,260],
            [170,90,290],
            [30,120,160],
            [100,190,230],
            [150,240,280],
            [115,20,85],
            [160,65,130],
            [230,135,200],
            [70,30,110],
            [130,90,170],
            [220,180,260],
            [100,25,50],
            [150,75,100],
            [210,135,160],
            [220,30,110],
            [160,70,150],
            [290,100,180],
            [200,40,110],
            [250,90,160],
            [180,120,190],
            [110,45,160],
            [160,95,210],
            [200,135,250],
            [35,115,125],
            [100,180,190],
            [180,260,270],
            [110,20,30],
            [170,80,90],
            [240,150,160],
            [140,50,80],
            [200,110,140],
            [280,190,220],
            [280,20,25],
            [290,30,35],
            [20,270,280],
            [30,280,290],
            [20,250,280],
            [30,260,290],
            [280,30,75],
            [290,40,85]
            ]

        triplet_list = jsPsych.randomization.shuffle(triplet_list)

        // debugger
        // Create the timeline variable
        var timeline_trials = [];
        
        for (i=0; i<triplet_list.length; i++){

            // Create the query image
            let query_img_el = document.createElement('img')
            query_img_el.id = 'query_img_element'
            query_img_el.src = './img/neck_legs_space/dim_1_stim_' + triplet_list[i][0] + '_x_' + triplet_list[i][0] + '_y_110.png'
            // query_img_el.style.width = '50'

            let ref1_img_el = document.createElement('img')
            ref1_img_el.id = 'ref1_img_element'
            ref1_img_el.src = './img/neck_legs_space/dim_1_stim_' + triplet_list[i][1] + '_x_' + triplet_list[i][1] + '_y_110.png'
            // ref1_img_el.style.width = '50'

            let ref2_img_el = document.createElement('img')
            ref2_img_el.id = 'ref2_img_element'
            ref2_img_el.src = './img/neck_legs_space/dim_1_stim_' + triplet_list[i][2] + '_x_' + triplet_list[i][2] + '_y_110.png'                        
            // ref2_img_el.style.width = '50'


            if (i%2 == 0){
                var ref1_pos_x = 30
                var ref2_pos_x = 430
            } else {
                var ref1_pos_x = 430
                var ref2_pos_x = 30
            }

            // debugger

            if (jatos.studySessionData.jitter.Jitter == 'Yes'){

                var ref1_pos_y = Math.floor(Math.random() * 200)
                var ref2_pos_y = Math.floor(Math.random() * 200)

            } else {

                var ref1_pos_y = 100
                var ref2_pos_y = 100

            }

            timeline_trials[i] = {

                query_img_el: query_img_el, 
                ref1_img_el: ref1_img_el,
                ref2_img_el: ref2_img_el,

                query_pos_x: 230,
                ref1_pos_x: ref1_pos_x,
                ref2_pos_x: ref2_pos_x,

                query_pos_y: 100,
                ref1_pos_y: ref1_pos_y,                
                ref2_pos_y: ref2_pos_y,                                

            }
        }
        
        var img_height = 400
        var img_width  = img_height/2

        jatos.studySessionData.timeline_trials = timeline_trials
        // to use the canvas stimulus function with timeline variables,
        // the jsPsych.timelineVariable() function can be used inside your stimulus function
        var trial_procedure = {
            timeline: [{
                type: 'canvas-keyboard-response',
                stimulus: function(c) {
                    var ctx = c.getContext('2d');
                    // debugger
                    ctx.canvas.width = 700,
                    ctx.canvas.height = 700,
                    // ctx.height = 700,
                    // ctx.style.border = '1px solid;'
                    ctx.drawImage(
                        jsPsych.timelineVariable('query_img_el'),
                        jsPsych.timelineVariable('query_pos_x'),
                        jsPsych.timelineVariable('query_pos_y'),
                        img_width,img_height
                    );
                    ctx.drawImage(
                        jsPsych.timelineVariable('ref1_img_el'),
                        jsPsych.timelineVariable('ref1_pos_x'),
                        jsPsych.timelineVariable('ref1_pos_y'),
                        img_width,img_height
                    );
                    ctx.drawImage(
                        jsPsych.timelineVariable('ref2_img_el'),
                        jsPsych.timelineVariable('ref2_pos_x'),
                        jsPsych.timelineVariable('ref2_pos_y'),
                        img_width,img_height
                    );                                        
                },
                choices: ['q','p'],
                prompt: '<p>Press "Q" or "P" for left/right.</p>',
                post_trial_gap: 1000
            }],

            timeline_variables: timeline_trials,
        };

        jsPsych.init({
            timeline: [trial_procedure],
            on_finish: function () { 
                jsPsych.data.displayData(); 
            }
        });

    
                // ///////////////////////////////////////////////////////////////////////////////////////////////
            //////////////////////////////////////////////////////////////////////////////////////////////////
        });
    
    </script>
</html>
